:scrollbar:
:data-uri:
:toc2:
:USER_GUID: %GUID%
:USERNAME: %user%
:CLUSTER: %cluster%

= OpenShift 4.3 on OpenStack 16.0 Installation Lab

In this lab, you will install OpenShift 4.3 on Red Hat OpenStack 16.0

== Overview

*OpenShift Container Platform* is a platform for developing and running containerized applications. It is designed to allow applications and the data centers that support them to expand from just a few machines and applications to thousands of machines that serve millions of clients.

In *OpenShift Container Platform 4.3*, you must use *RHCOS* for all control plane machines, but you can use *Red Hat Enterprise Linux* (*RHEL*) as the operating system for compute, or worker, machines. If you choose to use *RHEL* workers, you must perform more system maintenance than if you use RHCOS for all of the cluster machines.

With *OpenShift Container Platform 4.3*, if you have an account with the right permissions, you can deploy a production cluster in supported clouds by running a single command and providing a few values. You can also customize your cloud installation or install your cluster in your data center if you use a supported platform.

For clusters that use *RHCOS* for all machines, updating, or upgrading, *OpenShift Container Platform* is a simple, highly-automated process. Because *OpenShift Container Platform* completely controls the systems and services that run on each machine, including the operating system itself, from a central control plane, upgrades are designed to become automatic events.

== Architecture

=== Servers

[cols="1,2",caption="",options="header"]
|===============
| Server Name  | Description
| workstation | Jump host for the Lab
| undercloud| Red Hat Openstack Director
| ctrl01 | Controller
| compute01 | Compute node (12 CPUs + 32 GB RAM)
| compute02 | Compute node (12 CPUs + 32 GB RAM)
|===============

=== Networks

[cols="1,3",caption="",options="header"]
|===============
| Network | Description
| 192.0.2.0/24 | OSP Control Plane + Floating IP (flat network)
| 10.128.0.0/14 | OCP Cluster Network
| 10.0.0.0/16 | OCP Machine network
| 172.30.0.0/16 | OCP Service Network
|===============


== Floating Ips

[cols="1,3",caption="",options="header"]
|===============
| FIP | Description
| 192.0.2.XX | Autogenerated for the bootstrap
| 192.0.2.70 | Used for the API: api.summit.example.com
| 192.0.2.71 | Used for the APPS: *.apps.summit.example.com
|===============

== Overcloud preparation

In this section overcloud will be configured:

* Create a `public` network and subnet for floating ips.
* Create required flavor
* Create a image named `rhcos`
* Create a project named `openshift`
* Create an user named `openshift_admin` and assign role.
* Configure Swift permissions


=== Configure network and subnet

. Connect to your environment
[%nowrap]
----
[~] $ ssh %USERNAME%@workstation-%GUID%.%CLUSTER%.osp.opentlc.com
----

. Connect to `undercloud` (password is `r3dh4t1!` for user `stack`)
+
.[Workstation]
[%nowrap]
----
[student@workstation ~]$ ssh stack@undercloud.example.com
----

. Create network `public` as external network
+
[%nowrap]
----
[stack@undercloud ~]$ . overcloudrc
(overcloud) [stack@undercloud ~]$ openstack network create --provider-network-type flat --provider-physical-network datacentre public --external --share
----
+
.Sample Output
[%nowrap]
----
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | UP                                   |
| availability_zone_hints   |                                      |
| availability_zones        |                                      |
| created_at                | 2019-06-28T08:13:26Z                 |
| description               |                                      |
| dns_domain                | None                                 |
| id                        | 725b7803-45f2-4acd-992d-fa8a1fee28ec |
| ipv4_address_scope        | None                                 |
| ipv6_address_scope        | None                                 |
| is_default                | False                                |
| is_vlan_transparent       | None                                 |
| mtu                       | 1500                                 |
| name                      | public                               |
| port_security_enabled     | True                                 |
| project_id                | 6d6f875dd05240ba8ee773f2187f9c11     |
| provider:network_type     | flat                                 |
| provider:physical_network | datacentre                           |
| provider:segmentation_id  | None                                 |
| qos_policy_id             | None                                 |
| revision_number           | 6                                    |
| router:external           | External                             |
| segments                  | None                                 |
| shared                    | True                                 |
| status                    | ACTIVE                               |
| subnets                   |                                      |
| tags                      |                                      |
| updated_at                | 2019-06-28T08:13:26Z                 |
+---------------------------+--------------------------------------+
----

. Create subnet `public_subnet` to be used for floating IP
+
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ openstack subnet create --no-dhcp --gateway 192.0.2.254 --subnet-range 192.0.2.0/24 --allocation-pool start=192.0.2.50,end=192.0.2.90 --network public public_subnet
----
+
.Sample Output
[%nowrap]
----
+-------------------+--------------------------------------+
| Field             | Value                                |
+-------------------+--------------------------------------+
| allocation_pools  | 192.0.2.50-192.0.2.90                |
| cidr              | 192.0.2.0/24                         |
| created_at        | 2019-06-28T08:14:53Z                 |
| description       |                                      |
| dns_nameservers   |                                      |
| enable_dhcp       | False                                |
| gateway_ip        | 192.0.2.254                          |
| host_routes       |                                      |
| id                | e39a115e-c4c4-45cd-8653-4446cb5e8069 |
| ip_version        | 4                                    |
| ipv6_address_mode | None                                 |
| ipv6_ra_mode      | None                                 |
| name              | public_subnet                        |
| network_id        | 725b7803-45f2-4acd-992d-fa8a1fee28ec |
| project_id        | 6d6f875dd05240ba8ee773f2187f9c11     |
| revision_number   | 0                                    |
| segment_id        | None                                 |
| service_types     |                                      |
| subnetpool_id     | None                                 |
| tags              |                                      |
| updated_at        | 2019-06-28T08:14:53Z                 |
+-------------------+--------------------------------------+
----


=== Create flavor `m1.xlarge` and `m1.large`, create image `rhcos`

. Create flavor `m1.xlarge` with 8vcpu and 16GB of RAM for the controllers.
+
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ openstack flavor create --ram 16384 --disk 20 --vcpu 8 --public m1.xlarge
----
+
[%nowrap]
----
+----------------------------+--------------------------------------+
| Field                      | Value                                |
+----------------------------+--------------------------------------+
| OS-FLV-DISABLED:disabled   | False                                |
| OS-FLV-EXT-DATA:ephemeral  | 0                                    |
| disk                       | 20                                   |
| id                         | 6817178e-102e-4440-8897-b381df52311d |
| name                       | m1.xlarge                            |
| os-flavor-access:is_public | True                                 |
| properties                 |                                      |
| ram                        | 16384                                |
| rxtx_factor                | 1.0                                  |
| swap                       |                                      |
| vcpus                      | 8                                    |
+----------------------------+--------------------------------------+
----

. Create flavor `m1.large` with 4vcpu and 10GB of RAM for the workers.
+
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ openstack flavor create --ram 10240 --disk 20 --vcpu 4 --public m1.large
----
+
[%nowrap]
----
+----------------------------+--------------------------------------+
| Field                      | Value                                |
+----------------------------+--------------------------------------+
| OS-FLV-DISABLED:disabled   | False                                |
| OS-FLV-EXT-DATA:ephemeral  | 0                                    |
| disk                       | 20                                   |
| id                         | 2326ff2f-9ce1-4110-a587-5745cba517d6 |
| name                       | m1.large                             |
| os-flavor-access:is_public | True                                 |
| properties                 |                                      |
| ram                        | 10240                                |
| rxtx_factor                | 1.0                                  |
| swap                       |                                      |
| vcpus                      | 4                                    |
+----------------------------+--------------------------------------+
----


=== Create project for openshift, user and assign permissions

. Create project named `openshift`
+
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ openstack project create openshift
----
+
.Sample Output
[%nowrap]
----
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description |                                  |
| domain_id   | default                          |
| enabled     | True                             |
| id          | d4ca6cd93855497c90abb074aef473b5 |
| is_domain   | False                            |
| name        | openshift                        |
| parent_id   | default                          |
| tags        | []                               |
+-------------+----------------------------------+
----

. Set quota for the project (here we set unlimited ram and cores)
+
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ openstack quota set --ram -1 --cores -1 openshift
----

. Create an user named `openshift_admin`
+
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ openstack user create --password 'r3dh4t1!' openshift_admin
----
+
.Sample Output
[%nowrap]
----
+---------------------+----------------------------------+
| Field               | Value                            |
+---------------------+----------------------------------+
| domain_id           | default                          |
| enabled             | True                             |
| id                  | fe344863375f49d19bc8cb6023042cbd |
| name                | openshift_admin                  |
| options             | {}                               |
| password_expires_at | None                             |
+---------------------+----------------------------------+
----

. Assign _member_ role to the user in the project
+
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ openstack role add --project openshift --user openshift_admin _member_
----
+
[NOTE]
This command doesn't show any output when is executed correctly.

. Assign swiftoperator role to the user in the project
+
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ openstack role add --user openshift_admin --project openshift swiftoperator
----

. Create file `openshiftrc` to test authentication
+
.Content
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ cat > openshiftrc <<\EOF
for key in $( set | awk '{FS="="}  /^OS_/ {print $1}' ); do unset $key ; done
export OS_NO_CACHE=True
export COMPUTE_API_VERSION=1.1
export OS_USERNAME=openshift_admin
export no_proxy=,192.0.2.102,192.0.2.102
export OS_USER_DOMAIN_NAME=Default
export OS_VOLUME_API_VERSION=3
export OS_CLOUDNAME=openshift
export OS_AUTH_URL=http://192.0.2.21:5000//v3
export NOVA_VERSION=1.1
export OS_IMAGE_API_VERSION=2
export OS_PASSWORD=r3dh4t1!
export OS_PROJECT_DOMAIN_NAME=Default
export OS_IDENTITY_API_VERSION=3
export OS_PROJECT_NAME=openshift
export OS_AUTH_TYPE=password
export PYTHONWARNINGS="ignore:Certificate has no, ignore:A true SSLContext object is not available"

# Add OS_CLOUDNAME to PS1
if [ -z "${CLOUDPROMPT_ENABLED:-}" ]; then
    export PS1=${PS1:-""}
    export PS1=${OS_CLOUDNAME:+"($OS_CLOUDNAME)"}\ $PS1
    export CLOUDPROMPT_ENABLED=1
fi
EOF
----

. Test authentication
+
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ . openshiftrc
(openshift) [stack@undercloud ~]$ openstack network list
----
+
.Sample Output
[%nowrap]
----
+--------------------------------------+--------+--------------------------------------+
| ID                                   | Name   | Subnets                              |
+--------------------------------------+--------+--------------------------------------+
| 725b7803-45f2-4acd-992d-fa8a1fee28ec | public | e39a115e-c4c4-45cd-8653-4446cb5e8069 |
+--------------------------------------+--------+--------------------------------------+
----


. Create a floating IP
+
[%nowrap]
----
(overcloud) [stack@undercloud ~]$ openstack floating ip create public
----
+
.Sample Output
[%nowrap]
----
+---------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field               | Value                                                                                                                                                                                 |
+---------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| created_at          | 2020-02-24T09:28:50Z                                                                                                                                                                  |
| description         |                                                                                                                                                                                       |
| dns_domain          |                                                                                                                                                                                       |
| dns_name            |                                                                                                                                                                                       |
| fixed_ip_address    | None                                                                                                                                                                                  |
| floating_ip_address | 192.0.2.70                                                                                                                                                                            |
| floating_network_id | 41c71dd5-6f24-4de1-aea3-7cf2ddccbeed                                                                                                                                                  |
| id                  | 7b5a17bc-2ace-4805-9918-93203aca6315                                                                                                                                                  |
| location            | Munch({'cloud': '', 'region_name': '', 'zone': None, 'project': Munch({'id': '427c1fb25e4a4401bf4e0cde048738a9', 'name': 'openshift', 'domain_id': None, 'domain_name': 'Default'})}) |
| name                | 192.0.2.84                                                                                                                                                                            |
| port_details        | None                                                                                                                                                                                  |
| port_id             | None                                                                                                                                                                                  |
| project_id          | 427c1fb25e4a4401bf4e0cde048738a9                                                                                                                                                      |
| qos_policy_id       | None                                                                                                                                                                                  |
| revision_number     | 0                                                                                                                                                                                     |
| router_id           | None                                                                                                                                                                                  |
| status              | DOWN                                                                                                                                                                                  |
| subnet_id           | None                                                                                                                                                                                  |
| tags                | []                                                                                                                                                                                    |
| updated_at          | 2020-02-24T09:28:50Z                                                                                                                                                                  |
+---------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
----


. Add DNS record to point to the new Floating IP
[%nowrap]
----
(openshift) [stack@undercloud ~]$ FIP=$(openstack floating ip list -c "Floating IP Address" -f value)
(openshift) [stack@undercloud ~]$ curl "http://classroom.example.com:8080/update?secret=redhat&domain=api&addr=$FIP"
----
+
.Expected Output
[%nowrap]
----
{"Success":true,"Message":"Updated A record for api to IP address 192.0.2.88","Domain":"api","Domains":["api"],"Address":"192.0.2.88","AddrType":"A"}
----

. Ensure the DNS record is working properly
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ sudo yum install -y bind-utils
(openshift) [stack@undercloud ~]$ dig +short api.summit.example.com
192.0.2.88
----


. Set temporary url key for `openshift_admin` account. This is used by Swift when we generate a temporary public URL for files.
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack object store account set --property Temp-URL-Key=summitTempKey
----
. Ensure the temporary key is set
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack object store account show
----
+
.Sample Output
[%nowrap]
----
+------------+---------------------------------------+
| Field      | Value                                 |
+------------+---------------------------------------+
| Account    | AUTH_d4ca6cd93855497c90abb074aef473b5 |
| Bytes      | 0                                     |
| Containers | 0                                     |
| Objects    | 0                                     |
| properties | Temp-Url-Key='summitTempKey'            |
+------------+---------------------------------------+
----



== Download OpenShift installer


Latest installer binaries are available link:https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest[here].

. Create a working directory
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ mkdir openshift
(openshift) [stack@undercloud ~]$ cd openshift
----

. Download OpenShift 4.3 oc client from a local website
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ curl -O http://classroom.example.com/openshift-client-linux-4.3.1.tar.gz
----
+
.Sample Output
[%nowrap]
----
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 25.9M  100 25.9M    0     0  11.2M      0  0:00:02  0:00:02 --:--:-- 11.2M
----

. Uncompress and check version
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ sudo tar xvfz openshift-client-linux-4.3.1.tar.gz  -C /usr/bin/
(openshift) [stack@undercloud openshift]$ oc version
----
+
.Expected Output
[%nowrap]
----
Client Version: 4.3.1
----



== OpenShift 4.3 installation

In this section preparation for the installation and the installation will be performed.

. Get `openshift` project id
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ export PROJID=$(openstack project show openshift -c id -f value)
----
+

. Generate `clouds.yaml` file (file used for authentication)
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ cat > clouds.yaml <<EOF
clouds:
  openstack:
    auth:
      auth_url: http://192.0.2.21:5000/v3
      project_name: openshift
      username: openshift_admin
      password: r3dh4t1!
      user_domain_name: Default
      project_domain_name: Default
      project_id: $PROJID
EOF
----
+

. Create a `openshift-install` binary to use the disconnected installation.
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ echo '{"auths": { "quay.io": { "auth": "b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K2pvc2Vnb256cmVkaGF0Y29tMWxtcmI4ZmdvdW02aTlxd2R2MWpwMHhwam1pOkk2TVczVVdVUzJPWk1XSlJQT1EyOFhYOFJBREZBWTBEUU9WOFIzVk8xRzM5NE5KODdHMlE4V0VGWE1JTTlMWE8=", "email": "" }}}' > quay.json
(openshift) [stack@undercloud openshift]$ oc adm release extract -a quay.json --insecure  --command=openshift-install "classroom.example.com:5000/openshift4:4.3.1-x86_64"
----
+
[NOTE]
This step is only required when we use a disconnected installation. For normal installation you can use the binary from link:https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest[here]

. Ensure the binary was created correctly
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ ls -l openshift-install 
-rwxr-xr-x. 1 stack stack 329097376 Feb  3 18:04 openshift-install
----


. Generate a install configuration
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ ./openshift-install create install-config --dir summit
----
+

.Options to select (using `arrows keys` to select the indicated option and press enter in each question)
+
[%nowrap]
----
? SSH Public Key /home/stack/.ssh/id_rsa.pub
? Platform openstack
? Cloud openstack
? ExternalNetwork public
? APIFloatingIPAddress 192.0.2.70
? FlavorName m1.xlarge
? Base Domain example.com
? Cluster Name summit
? Pull Secret {"auths": { "quay.io": { "auth": "Y29yZW9zK3RlYzJfaWZidWdsa2VndmF0aXJyemlqZGMybnJ5ZzpWRVM0SVA0TjdSTjNROUUwMFA1Rk9NMjdSQUZNM1lIRjRYSzQ2UlJBTTFZQVdZWTdLOUFIQlM1OVBQVjhEVlla", "email": "" }, "registry.redhat.io": {"auth": "NjM0MDA1NnxvY3A0LW9zcDE2OmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJNE9EVXhNemcyTjJRek56TTBaV1poT1dZd05HUTBNMlptWlRKbFptUTRNaUo5LnZtMS15WnE1T1hYSmxrT18zMlhlTVdISGRaWHpUS1F5VTFuVXNWbm9vUzVxSjB5cWl5blVJZlpnOEZMTWR6bEgwb0lNU09ZR0p2YkdtM0kzdjkzZjBLQTBsSjNTcmZiX2Q5Yl9JWjVfb0dydTd6QmVnRzR0NWllRmd2T255YzN0a1Uxb2ZPMzY5VWVYNGxfdFU0RXZDdlNDYUV5S3NUZGI3RzlaN19vUmtmLWpmQnVZWl9TdjZ3WmFuUmszREtEckxweTB1T1VOUUFVYXVTbEgtTV9UTTNKZUUydTRfUVlHaTY4X01kb2ZZaUpnSE92UFJOb20tYWJ2bEFzaG8zTEFlVXlJQlNwbW5rYmNMSGhnMXM3REhOaWttZFgxdThLTGdYQTgzS1VkRW9JYW1zREgwTmxDdkp6RlQ1Ym4zX0VSYk1GMW02ODd2OFNmeE1RSGR1dWwxdDVNa2JMZU1KYThFb0ZLSmdoRUZiNGlVcWZmZmJpTUF0QXhhLVN1dV9aUWs1eW10WWFEbW1uQlp2eXA0c2VGS0FzNW5xYUtrdS1MenRYVEE5c1VKc0l1YVpVTDFwSmVIOElyblRJN2R0dGgySlpYTm8wM3c5Q0ZlVWtub29hSUtIN0k0MXc2MlFGQjZkMkNJeENjR0lHRXpBV3VQWEotX1BGR1FDRmp5M0k0alZvYnRlRFVHYmJvTlNmYk95dmU3U1ZISWY4N21TMjJZZmpZVEtwLTd1eXpSNXB0STBUVDdMVHhiei16Y0VYOVc3b2EySHZVNThPR2dqVTRsRXhleHhNc0Jqdnp4VTJxR19RYUE3SUhtQTcweDZiRlRSemFkd0tZaFg3NEN6U2JOb1NXdmV0S1RvRnhXdnloQnNyWnZoektHeEZrckctT3V3TzhoN0NkdnRv", "email": "6340056|ocp43-osp16"}}}
----
+
[NOTE]
For this lab you can use this `Pull Secret`, for other environments you can generate your own using `https://try.openshift.com` website.


. Check the `install-config.yaml` generated
+
[%nowrap]
----
cat ./summit/install-config.yaml
----
+

.Expected Output
+
[source,yaml]
----
apiVersion: v1
baseDomain: example.com
compute:
- hyperthreading: Enabled
  name: worker
  platform: {}
  replicas: 3
controlPlane:
  hyperthreading: Enabled
  name: master
  platform: {}
  replicas: 3
metadata:
  creationTimestamp: null
  name: summit
networking:
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  machineCIDR: 10.0.0.0/16
  networkType: OpenShiftSDN
  serviceNetwork:
  - 172.30.0.0/16
platform:
  openstack:
    cloud: openstack
    computeFlavor: m1.xlarge
    externalDNS: null
    externalNetwork: public
    lbFloatingIP: 192.0.2.88
    octaviaSupport: "0"
    region: ""
    trunkSupport: "1"
publish: External
pullSecret: '{"auths": { "quay.io": { "auth": "Y29yZW9zK3RlYzJfaWZidWdsa2VndmF0aXJyemlqZGMybnJ5ZzpWRVM0SVA0TjdSTjNROUUwMFA1Rk9NMjdSQUZNM1lIRjRYSzQ2UlJBTTFZQVdZWTdLOUFIQlM1OVBQVjhEVlla",
  "email": "" }, "registry.redhat.io": {"auth": "NjM0MDA1NnxvY3A0LW9zcDE2OmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJNE9EVXhNemcyTjJRek56TTBaV1poT1dZd05HUTBNMlptWlRKbFptUTRNaUo5LnZtMS15WnE1T1hYSmxrT18zMlhlTVdISGRaWHpUS1F5VTFuVXNWbm9vUzVxSjB5cWl5blVJZlpnOEZMTWR6bEgwb0lNU09ZR0p2YkdtM0kzdjkzZjBLQTBsSjNTcmZiX2Q5Yl9JWjVfb0dydTd6QmVnRzR0NWllRmd2T255YzN0a1Uxb2ZPMzY5VWVYNGxfdFU0RXZDdlNDYUV5S3NUZGI3RzlaN19vUmtmLWpmQnVZWl9TdjZ3WmFuUmszREtEckxweTB1T1VOUUFVYXVTbEgtTV9UTTNKZUUydTRfUVlHaTY4X01kb2ZZaUpnSE92UFJOb20tYWJ2bEFzaG8zTEFlVXlJQlNwbW5rYmNMSGhnMXM3REhOaWttZFgxdThLTGdYQTgzS1VkRW9JYW1zREgwTmxDdkp6RlQ1Ym4zX0VSYk1GMW02ODd2OFNmeE1RSGR1dWwxdDVNa2JMZU1KYThFb0ZLSmdoRUZiNGlVcWZmZmJpTUF0QXhhLVN1dV9aUWs1eW10WWFEbW1uQlp2eXA0c2VGS0FzNW5xYUtrdS1MenRYVEE5c1VKc0l1YVpVTDFwSmVIOElyblRJN2R0dGgySlpYTm8wM3c5Q0ZlVWtub29hSUtIN0k0MXc2MlFGQjZkMkNJeENjR0lHRXpBV3VQWEotX1BGR1FDRmp5M0k0alZvYnRlRFVHYmJvTlNmYk95dmU3U1ZISWY4N21TMjJZZmpZVEtwLTd1eXpSNXB0STBUVDdMVHhiei16Y0VYOVc3b2EySHZVNThPR2dqVTRsRXhleHhNc0Jqdnp4VTJxR19RYUE3SUhtQTcweDZiRlRSemFkd0tZaFg3NEN6U2JOb1NXdmV0S1RvRnhXdnloQnNyWnZoektHeEZrckctT3V3TzhoN0NkdnRv",
  "email": "6340056|ocp43-osp16"}}}'
sshKey: |
  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAAgQClVxORiGBXlpI0fy7DBrJgreQWruKbZ2yOD04XL0GrNmbIEQZZb0A2LI07ieVw89IyH1MuGvCfeebsXwoOY7PyHzvjKZVL6hpZa5exgoIaxlvbKqiUKpjNr3CK7jjOHu6ZkDYb0EUaJ+tOAtsNJnrx6eJnn5w8ACVfna7N1Tqpdw== root@undercloud.example.com
----
+

. Reduce the cluster to use only one controlPlane and compute.
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ sed -i 's/replicas: 3/replicas: 1/' ./summit/install-config.yaml
----
+

. Change the flavor type for the compute (worker) nodes to use `m1.large`
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ sed -i '6s/.*/  platform: {"openstack": {"type": "m1.large"}}/' ./summit/install-config.yaml
----
+

. Review the changes
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ head -7 ./summit/install-config.yaml
----
+

.Sample Output
[%nowrap]
----
apiVersion: v1
baseDomain: example.com
compute:
- hyperthreading: Enabled
  name: worker
  platform: {"openstack": {"type": "m1.large"}}
  replicas: 1
----
+


. Specify where the repository for the mirrored images.
+
The lab's image registry have already synchronized the images for OpenShift 4.3, but in this task you will run the commands to get the configuration required for the `install-config.yaml`
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ export LOCAL_REGISTRY=classroom.example.com:5000
(openshift) [stack@undercloud openshift]$ export LOCAL_REPOSITORY='openshift4'
(openshift) [stack@undercloud openshift]$ export RELEASE_NAME="ocp-release"
(openshift) [stack@undercloud openshift]$ export OCP_RELEASE=4.3.1-x86_64
(openshift) [stack@undercloud openshift]$ export PRODUCT_REPO='openshift-release-dev'
(openshift) [stack@undercloud openshift]$ oc adm release mirror -a quay.json    --insecure=true  --from=quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:4.3.1-x86_64      --to=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}      --to-release-image=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE} --dry-run
----
+

.Sample Output
[%nowrap]
----
info: Mirroring 101 images to classroom.example.com:5000/openshift4 ...
classroom.example.com:5000/
  openshift4
<<OMITTED>>
To use the new mirrored repository to install, add the following section to the install-config.yaml:

imageContentSources:
- mirrors:
  - classroom.example.com:5000/openshift4
  source: quay.io/openshift-release-dev/ocp-release
- mirrors:
  - classroom.example.com:5000/openshift4
  source: quay.io/openshift-release-dev/ocp-v4.0-art-dev
<<OMITTED>>
----

. Add `imageContentSources` section to the `install-config.yaml` file
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ cat >> summit/install-config.yaml <<EOF
imageContentSources:
- mirrors:
  - classroom.example.com:5000/openshift4
  source: quay.io/openshift-release-dev/ocp-release
- mirrors:
  - classroom.example.com:5000/openshift4
  source: quay.io/openshift-release-dev/ocp-v4.0-art-dev
EOF
----

. Trust SSL self-signed certitification
+
Image registry is configured with a self-signed certification, we can add it as trusted on section `additionalTrustBundle`
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ cat >> summit/install-config.yaml <<\EOF
additionalTrustBundle: |
  -----BEGIN CERTIFICATE-----
  MIIGJTCCBA2gAwIBAgIUV/YBpie1Sh4q8k7htRkiJNYBNxUwDQYJKoZIhvcNAQEL
  BQAwgaExCzAJBgNVBAYTAkRFMQ8wDQYDVQQIDAZCZXJsaW4xDzANBgNVBAcMBkJl
  cmxpbjEVMBMGA1UECgwMUmVkIEhhdCBHbWJIMQ0wCwYDVQQLDARHUFRFMR4wHAYD
  VQQDDBVjbGFzc3Jvb20uZXhhbXBsZS5jb20xKjAoBgkqhkiG9w0BCQEWG2FsYmVy
  dG8uZ29uemFsZXpAcmVkaGF0LmNvbTAeFw0yMDAyMTgyMjAzMjVaFw0yMTAyMTcy
  MjAzMjVaMIGhMQswCQYDVQQGEwJERTEPMA0GA1UECAwGQmVybGluMQ8wDQYDVQQH
  DAZCZXJsaW4xFTATBgNVBAoMDFJlZCBIYXQgR21iSDENMAsGA1UECwwER1BURTEe
  MBwGA1UEAwwVY2xhc3Nyb29tLmV4YW1wbGUuY29tMSowKAYJKoZIhvcNAQkBFhth
  bGJlcnRvLmdvbnphbGV6QHJlZGhhdC5jb20wggIiMA0GCSqGSIb3DQEBAQUAA4IC
  DwAwggIKAoICAQDdurjq0YL1g6bpu+Hop+UCk5CT6ihnlWr/AYEqZ+mneahU0vFA
  47zK20rWSa45Mb/Els2VsiYM61ax53pq/swyhNVLUSao++aF7M86SFZ1/ST6hXq7
  cD47c/8I0Gel3iqhSit5wpR9dbGrgDvOVdSR30ZYaCMnNuPA5qLGmM5XKF0ixlC8
  Q79HJtL20HIVgmhcyQnRc29uyzIcDkEn2R95bxRKIClXYZOVbEGd2fwGMSH7qVbg
  kowTD/n8BtBjHfiOI2AXql5tBi+ls2yUGeUYYKD+yYmrb/rhilZtkjH3K32m1NO3
  uIQDW8tZmJGLENx6hvO3OUti4tjmzfdU/LDj4DB0PCQaDlc2LzXXreN13oswJXbd
  hILfKrNXHIzK79TKlBAW7CuNSks7VNlbdScXA9elupcLp2cJn57ODLHKtxRI6HI3
  9LVgJ4UYFMco7XsCeLTHG5DLWvhshU0unHXvgwhrF1PmlXXXlr8GNYnJO5kRehrA
  1NwygTK6GG0kKwHy2QJktFW5RokAgYQotLrP0HeBFUND5X9NwGDW1JUw71cZ2w7A
  2AGFEcaQEb5SLG/dcDoWpQKjilwAG200bTQ/bbwvH0S2LIwnd/esrLfeONunuMR9
  Z+s5YU8ps8Rm44BdmWo2fNuZKGS6h1zLetxvUEFZ9eIXLdZrz13Qt25ouQIDAQAB
  o1MwUTAdBgNVHQ4EFgQU/qpVEG0TlFXgv39HhZC1aKutrccwHwYDVR0jBBgwFoAU
  /qpVEG0TlFXgv39HhZC1aKutrccwDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG9w0B
  AQsFAAOCAgEAoG4h/kUaDYLStqUjVBgExBXXAjbF003dw/aDqv4heKjUISsgZ1HB
  fxWb5h3An1QwHnwOswUcY8reg7Lz23M35ip6dfsdV4GMKo1z0A5o8FlJWS+xXMz8
  tWn4KXPiFWt0DFF+9JJxOPqrPlPwom3yReMQAnJmdp5ewF34RaBiXAOgxaLYjasu
  orEX8JMsUItQN7XTbi/pgWN312XXgfdIjteXQktjln3MMOde1gJDQ/UoKJbvNqfH
  X/j6yqAv3/qyPckdHH3UEGSjXGCI6HWeJ/3XJxfZKvrdPi3+dfMo7npu/07X8GeU
  ZwTXsNxouXjJVI1M1OOhP6so3/HZsI7Nm6EkYDD1FNi3v5/i75iAo09yDhN9vBsM
  CyZ/gw5gqu7wc+XI+m9fbssn44vFlOMf6gBsrPNwh1Q2TIGmvuV27DnQXR4m+NhO
  tg7LazvkvPusJf7u+2HKsHr1bxnx/3i6DQsN2Wcu73TFMR3W5MZuLh2o7D778YKe
  3jaO7liRNGRJ8DTnuj9dlCSI/zQxVKHi4rLjkzKdNYlnh9cimhKaGQM22DxNEdQ2
  fjnGjicHPEthw+olSyyiZZcQpie+oz1yyZO/5F5/V/YmmBwwZCM2GaFwllY95tbB
  YrPjChqUxUug1+cdHcjU56cc0AGqg3kEQ2bvSa9raoDN0keu18aw+LA=
  -----END CERTIFICATE-----
EOF
----

. (Optional) Generate `ignition` files
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ openshift-install create ignition-configs --dir summit
(openshift) [stack@undercloud openshift]$ ls ./summit/*.ign
summit/bootstrap.ign  summit/master.ign  summit/worker.ign
----
+
[NOTE]
Ignition is a provisioning utility designed specifically for *CoreOS Container Linux*.
+
[NOTE]
At the the most basic level, it is a tool for manipulating disks during early boot. This includes partitioning disks, formatting partitions, writing files (regular files, systemd units, networkd units, etc.), and configuring users. On first boot, Ignition reads its configuration from a source-of-truth (remote URL, network metadata service, hypervisor bridge, etc.) and applies the configuration.

. (Optional) Generate Kubernetes `manifests` files
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ openshift-install create manifests  --dir ./summit
INFO Consuming "Master Ignition Config" from target directory
INFO Consuming "Worker Ignition Config" from target directory
----
+

.. Review the files
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ ls ./summit/manifests/
----
+

.Sample Output
[%nowrap]
----
04-openshift-machine-config-operator.yaml  cluster-network-01-crd.yml       etcd-client-secret.yaml                etcd-namespace.yaml                 machine-config-server-tls-secret.yaml
cloud-provider-config.yaml                 cluster-network-02-config.yml    etcd-host-service-endpoints.yaml       etcd-service.yaml                   openshift-config-secret-pull-secret.yaml
cluster-config.yaml                        cluster-proxy-01-config.yaml     etcd-host-service.yaml                 etcd-serving-ca-configmap.yaml
cluster-dns-02-config.yml                  cluster-scheduler-02-config.yml  etcd-metric-client-secret.yaml         etcd-signer-secret.yaml
cluster-infrastructure-02-config.yml       cvo-overrides.yaml               etcd-metric-serving-ca-configmap.yaml  kube-cloud-config.yaml
cluster-ingress-02-config.yml              etcd-ca-bundle-configmap.yaml    etcd-metric-signer-secret.yaml         kube-system-configmap-root-ca.yaml
----
+

. Configure where RHCOS image is hosted.
+
By default on `Red Hat OpenShift 4.3` Red Hat Core OS image for OpenStack is downloaded automatically and uploaded to Glance. As in this lab we are simulating a disconnected environment, we should override the default location
+

[%nowrap]
----
(openshift) [stack@undercloud openshift]$ export OPENSHIFT_INSTALL_OS_IMAGE_OVERRIDE=http://classroom.example.com/rhcos-43.qcow2 
----


. Run installer (creating first cluster installation working directory)
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ time ./openshift-install --log-level=debug create cluster --dir summit
----
+

.Sample Output
[%nowrap]
----
DEBUG OpenShift Installer unreleased-master-1199-g06474dd31b58a4e4299473d41a4ab85cd488ebfc
DEBUG Built from commit 06474dd31b58a4e4299473d41a4ab85cd488ebfc
DEBUG Fetching "Terraform Variables"...
DEBUG Loading "Terraform Variables"...
DEBUG   Loading "Cluster ID"...
DEBUG     Loading "Install Config"...
DEBUG       Loading "SSH Key"...
DEBUG       Loading "Base Domain"...
DEBUG         Loading "Platform"...
DEBUG       Loading "Cluster Name"...
DEBUG         Loading "Base Domain"...
DEBUG       Loading "Pull Secret"...
DEBUG       Loading "Platform"...
DEBUG     Using "Install Config" loaded from target directory
DEBUG   Loading "Install Config"...
DEBUG   Loading "Image"...
DEBUG     Loading "Install Config"...
DEBUG   Loading "Bootstrap Ignition Config"...
DEBUG     Loading "Install Config"...
DEBUG     Loading "Kubeconfig Admin Client"...
<<OMITTED>>
----
+
[NOTE]
Installation will take around 40 minutes. Please go to the next section to review the installation process.

=== Review installation process

Wait till the installer shows the following messsage
[%nowrap]
----
INFO Waiting up to 1h0m0s for the Kubernetes API at https://api.summit.example.com:6443...
DEBUG Still waiting for the Kubernetes API: the server could not find the requested resource
----

Last message indicates the master VM is sarted and is doing the bootstrap process..


Open a new session to `undercloud` server.

. Review created networks during installation
+
[%nowrap]
----

(openshift) [stack@undercloud ~]$ openstack network list 
----
+
.Sample Output
[%nowrap]
----
+--------------------------------------+----------------------+--------------------------------------+
| ID                                   | Name                 | Subnets                              |
+--------------------------------------+----------------------+--------------------------------------+
| 41c71dd5-6f24-4de1-aea3-7cf2ddccbeed | public               | d92f326f-48f1-4a57-9439-b58e69af7727 |
| 83e4f7b8-2d2a-44f7-9a3c-26698d698726 | summit-dtx69-openshift | c9ac1bae-e44c-41e3-84b6-33991fa39ebe |
+--------------------------------------+----------------------+--------------------------------------+
----

. Review created subnet during installation
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack subnet list
----
+
.Sample Output
[%nowrap]
----
+--------------------------------------+------------------+--------------------------------------+--------------+
| ID                                   | Name             | Network                              | Subnet       |
+--------------------------------------+------------------+--------------------------------------+--------------+
| d92f326f-48f1-4a57-9439-b58e69af7727 | public_subnet    | 41c71dd5-6f24-4de1-aea3-7cf2ddccbeed | 192.0.2.0/24 |
| c9ac1bae-e44c-41e3-84b6-33991fa39ebe | summit-dtx69-nodes | 83e4f7b8-2d2a-44f7-9a3c-26698d698726 | 10.0.0.0/16 |
+--------------------------------------+------------------+--------------------------------------+--------------+
----

. Review the servers created
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack server list
----
+
[%nowrap]
----
+--------------------------------------+----------------------+--------+----------------------------------------------+-------+-----------+
| ID                                   | Name                 | Status | Networks                                     | Image | Flavor    |
+--------------------------------------+----------------------+--------+----------------------------------------------+-------+-----------+
| a438ee52-66dc-4612-83ae-e3e09ee14df8 | summit-dtx69-master-0  | ACTIVE | summit-dtx69-openshift=10.0.0.19              | rhcos | m1.xlarge |
| 0e05fa34-3bf7-4089-a291-b2cb2c75c9be | summit-dtx69-bootstrap | ACTIVE | summit-dtx69-openshift=10.0.0.28, 192.0.2.68 | rhcos | m1.xlarge |
+--------------------------------------+----------------------+--------+----------------------------------------------+-------+-----------+
----
+
[NOTE]
Notice one temporary Floating IP is created on the bootstrap node. This floating IP will be released automatically after the bootstrap node finishes.

. List the security groups created
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack security group list
----
+
.Sample Output
[%nowrap]
----
+--------------------------------------+-------------------+------------------------+----------------------------------+
| ID                                   | Name              | Description            | Project                          |
+--------------------------------------+-------------------+------------------------+----------------------------------+
| 79745641-682d-449d-b1e0-903ec789fc91 | summit-dtx69-worker |                        | 31cd4d29cf6c479d9a72784ff4e4ad3c |
| b560d600-c35a-4e42-8ca3-ebbd42af049a | summit-dtx69-master |                        | 31cd4d29cf6c479d9a72784ff4e4ad3c |
| c9112863-5612-472a-99d2-43ea867e5176 | default           | Default security group | 31cd4d29cf6c479d9a72784ff4e4ad3c |
+--------------------------------------+-------------------+------------------------+----------------------------------+
----
+
[NOTE]
You can explore the rules created using the command `openstack security group rule list SGNAME`

. List the trunk ports
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack network trunk list
----
+
.Sample Output
[%nowrap]
----
+--------------------------------------+---------------------------+--------------------------------------+-------------+
| ID                                   | Name                      | Parent Port                          | Description |
+--------------------------------------+---------------------------+--------------------------------------+-------------+
| a2986abe-19de-4585-a715-c50b6f581a61 | summit-dtx69-master-trunk-0 | de3cd481-28d5-42f8-b0ba-c10127a0e034 |             |
+--------------------------------------+---------------------------+--------------------------------------+-------------+
----

. Show the trunk parent port
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ for port in $(openstack network trunk list -c "Parent Port" -f value) ; do openstack port show $port ; done
----
+
.Sample Port
+
[%nowrap]
----
+-----------------------+--------------------------------------------------------------------------------------------------+
| Field                 | Value                                                                                            |
+-----------------------+--------------------------------------------------------------------------------------------------+
| admin_state_up        | UP                                                                                               |
| allowed_address_pairs | ip_address='10.0.0.5', mac_address='fa:16:3e:44:bc:6e'                                          |
|                       | ip_address='10.0.0.6', mac_address='fa:16:3e:44:bc:6e'                                          |
|                       | ip_address='10.0.0.7', mac_address='fa:16:3e:44:bc:6e'                                          |
| binding_host_id       | overcloud-compute-0.localdomain                                                                  |
| binding_profile       |                                                                                                  |
| binding_vif_details   | bridge_name='tbr-a2986abe-1', datapath_type='system', ovs_hybrid_plug='True', port_filter='True' |
| binding_vif_type      | ovs                                                                                              |
| binding_vnic_type     | normal                                                                                           |
| created_at            | 2019-08-27T14:48:52Z                                                                             |
| data_plane_status     | None                                                                                             |
| description           |                                                                                                  |
| device_id             | a438ee52-66dc-4612-83ae-e3e09ee14df8                                                             |
| device_owner          | compute:nova                                                                                     |
| dns_assignment        | None                                                                                             |
| dns_name              | None                                                                                             |
| extra_dhcp_opts       | ip_version='4', opt_name='domain-search', opt_value='summit.example.com'                           |
| fixed_ips             | ip_address='10.0.0.19', subnet_id='c9ac1bae-e44c-41e3-84b6-33991fa39ebe'                        |
| id                    | de3cd481-28d5-42f8-b0ba-c10127a0e034                                                             |
| ip_address            | None                                                                                             |
| mac_address           | fa:16:3e:44:bc:6e                                                                                |
| name                  | summit-dtx69-master-port-0                                                                         |
| network_id            | 83e4f7b8-2d2a-44f7-9a3c-26698d698726                                                             |
| option_name           | None                                                                                             |
| option_value          | None                                                                                             |
| port_security_enabled | True                                                                                             |
| project_id            | 31cd4d29cf6c479d9a72784ff4e4ad3c                                                                 |
| qos_policy_id         | None                                                                                             |
| revision_number       | 14                                                                                               |
| security_group_ids    | b560d600-c35a-4e42-8ca3-ebbd42af049a                                                             |
| status                | ACTIVE                                                                                           |
| subnet_id             | None                                                                                             |
| tags                  | openshiftClusterID=summit-dtx69                                                                    |
| trunk_details         | {u'trunk_id': u'a2986abe-19de-4585-a715-c50b6f581a61', u'sub_ports': []}                         |
| updated_at            | 2019-08-27T14:50:54Z                                                                             |
+-----------------------+--------------------------------------------------------------------------------------------------+
----
+
[NOTE]
Notice the field `allowed_address_pairs`

. Check the floating IP indicated in the configuration
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack floating ip list
----
+
.Sample Output
[%nowrap]
----
+--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
| ID                                   | Floating IP Address | Fixed IP Address | Port                                 | Floating Network                     | Project                          |
+--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
| 3328127d-7b2c-44b4-a4f9-4353715a97ed | 192.0.2.50         | 10.0.0.13        | 0a373aa6-96d9-4927-9de2-a22e77bac3b8 | 42844de6-877b-45d1-a851-53838120334e | f8208bd072944d7f9d5f64b9181a386b |
| 4846fee6-23da-42a7-a494-f39332855b61 | 192.0.2.70         | 10.0.0.5         | 76f0f8e3-9701-44cb-ac76-8ff8b6de8e58 | 42844de6-877b-45d1-a851-53838120334e | 6d6f875dd05240ba8ee773f2187f9c11 |
+--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
----


. List the Swift Container created
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack container list
----
+
.Sample Output
[%nowrap]
----
+------------+
| Name       |
+------------+
| summit-dtx69 |
+------------+
----

. Check the objects inside
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ CONTAINER=$(openstack container list -c Name -f value)
(openshift) [stack@undercloud ~]$ openstack object list $CONTAINER
----
+

.Sample Output
[%nowrap]
----
+---------------+
| Name          |
+---------------+
| bootstrap.ign |
+---------------+
----
+
[NOTE]
This file is going to be used by RHCOS during the ignition disks boot process.

. Review the `bootstrap.ign` file
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack object save $CONTAINER bootstrap.ign --file -| jq "." | less
----

. Review the Terraform state
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ cd openshift
(openshift) [stack@undercloud openshift]$ jq "." summit/terraform.tfstate
----
+
.Sample Output
[%nowrap]
----
<<OMITTED>>
  {
      "instances": [
        {
          "attributes": {
            "uid": null,
            "source": null,
            "path": "/etc/hostname",
            "mode": 420,
            "id": "a50ae36aff38e0bc7b3b3a121226bed00e9e54124bb94aac3659835c37da8ba4",
            "gid": null,
            "filesystem": "root",
            "content": [
              {
                "mime": "text/plain",
                "content": "summit-4vfvz-master-0\n"
              }
            ]
          },
          "schema_version": 0,
          "index_key": 0
        }
      ],
      "provider": "provider.ignition",
      "each": "list",
      "name": "hostname",
      "type": "ignition_file",
      "mode": "data",
      "module": "module.masters"
    },
    {
      "instances": [
        {
          "attributes": {
            "vcpus": 8,
            "swap": 0,
            "rx_tx_factor": 1,
            "region": null,
            "ram": 16384,
            "disk": 20,
            "extra_specs": {},
            "flavor_id": "9d6becda-d356-4e5d-a219-cb05f85c632c",
            "id": "9d6becda-d356-4e5d-a219-cb05f85c632c",
            "is_public": true,
            "min_disk": null,
            "min_ram": null,
            "name": "m1.xlarge"
          },
          "schema_version": 0
        }
<<OMITTED>>
----

=== Check installation progress
. Connect to the floating  IP of the bootstrap (this Floating IP will be assigned to the masters after bootstrap)
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ FIP=$(openstack floating ip list -c "Floating IP Address" -f value --fixed-ip 10.0.0.5 )
(openshift) [stack@undercloud ~]$ ssh core@$FIP
----
. Review the bootstrap process
+
[%nowrap]
----
[core@bootstrap ~]$  journalctl -b -f -u bootkube.service
----
+
.Sample Output
[%nowrap]
----
Jun 28 09:47:06 bootstrap bootkube.sh[1380]: Starting etcd certificate signer...
Jun 28 09:47:21 bootstrap bootkube.sh[1380]: ac65eb7db95182d365de5cc416bffb90ae923757c28ae84e156494afd18c9769
Jun 28 09:47:21 bootstrap bootkube.sh[1380]: Waiting for etcd cluster...
----

. During the bootstrap the `openshift-install` output will show following messages:
+
[%nowrap]
----
INFO Waiting up to 30m0s for the Kubernetes API at https://api.summit.example.com:6443...
<OMITTED>>
DEBUG Still waiting for the Kubernetes API: Get https://api.summit.example.com:6443/version?timeout=32s: dial tcp 192.0.2.70:6443: connect: no route to host
DEBUG Still waiting for the Kubernetes API: Get https://api.summit.example.com:6443/version?timeout=32s: dial tcp 192.0.2.70:6443: connect: no route to host
DEBUG Still waiting for the Kubernetes API: Get https://api.summit.example.com:6443/version?timeout=32s: dial tcp 192.0.2.70:6443: connect: no route to host
DEBUG Still waiting for the Kubernetes API: the server could not find the requested resource
<<OMITTED>>
DEBUG Still waiting for the Kubernetes API: Get https://api.summit.example.com:6443/version?timeout=32s: dial tcp 192.0.2.70:6443: connect: connection refused

----

. The bootstrap VM will show the following message (example):
+
[%nowrap]
----
Jun 28 09:52:29 bootstrap bootkube.sh[1380]: https://etcd-0.summit.example.com:2379 is healthy: successfully committed proposal: took = 3.178716ms
Jun 28 09:52:29 bootstrap bootkube.sh[1380]: etcd cluster up. Killing etcd certificate signer...
Jun 28 09:52:30 bootstrap bootkube.sh[1380]: ac65eb7db95182d365de5cc416bffb90ae923757c28ae84e156494afd18c9769
Jun 28 09:52:30 bootstrap bootkube.sh[1380]: Starting cluster-bootstrap...
Jun 28 09:52:35 bootstrap bootkube.sh[1380]: Starting temporary bootstrap control plane...
<<OMITTED>>
Jun 28 09:53:04 bootstrap bootkube.sh[1380]: Created "cluster-dns-02-config.yml" dnses.v1.config.openshift.io/cluster -n
Jun 28 09:53:04 bootstrap bootkube.sh[1380]: Created "cluster-infrastructure-02-config.yml" infrastructures.v1.config.openshift.io/cluster -n
Jun 28 09:53:04 bootstrap bootkube.sh[1380]: Created "cluster-ingress-02-config.yml" ingresses.v1.config.openshift.io/cluster -n
Jun 28 09:53:04 bootstrap bootkube.sh[1380]: Created "cluster-network-02-config.yml" networks.v1.config.openshift.io/cluster -n
Jun 28 09:53:05 bootstrap bootkube.sh[1380]: Created "cluster-proxy-01-config.yaml" proxies.v1.config.openshift.io/cluster -n
Jun 28 09:53:05 bootstrap bootkube.sh[1380]:         Pod Status:openshift-kube-apiserver/kube-apiserver        DoesNotExist
Jun 28 09:53:05 bootstrap bootkube.sh[1380]:         Pod Status:openshift-kube-scheduler/openshift-kube-scheduler        DoesNotExist
Jun 28 09:53:05 bootstrap bootkube.sh[1380]:         Pod Status:openshift-kube-controller-manager/kube-controller-manager        DoesNotExist
Jun 28 09:53:05 bootstrap bootkube.sh[1380]:         Pod Status:openshift-cluster-version/cluster-version-operator        Pending
Jun 28 09:53:05 bootstrap bootkube.sh[1380]: Created "cvo-overrides.yaml" clusterversions.v1.config.openshift.io/version -n openshift-cluster-version
----


. Open a new session to `undercloud` and create file `.ssh/config` using the FIP as jump host
+
.Content
[%nowrap]
----
(openshift) [stack@undercloud ~]$ cat > ~/.ssh/config <<EOF
Host 10.0.*.*
  ProxyJump core@$FIP
EOF
(openshift) [stack@undercloud ~]$ chmod 640 ~/.ssh/config
----

. At this moment we have to wait till the bootstrap finishes. During this wait, open a new terminal and connect to master node
+
[%nowrap]
----

(openshift) [stack@undercloud ~]$ openstack server ssh --private $(openstack server list --name master -c Name -f value) -l core
----

. List the CRI-O pods inside the master
+
[%nowrap]
----
[core@master-0 ~]$ sudo -i
[root@master-0 ~]# crictl pods ps
----
+
.Sample Output
[%nowrap]
----
POD ID              CREATED             STATE               NAME                                 NAMESPACE             ATTEMPT
050c77479fa42       2 minutes ago       Ready               haproxy-summit-dtx69-master-0          openshift-kni-infra   0
94ae1d12e1364       2 minutes ago       Ready               keepalived-summit-dtx69-master-0       openshift-kni-infra   0
006799285b12a       2 minutes ago       Ready               mdns-publisher-summit-dtx69-master-0   openshift-kni-infra   0
94981f6fa3254       2 minutes ago       Ready               etcd-member-summit-dtx69-master-0      openshift-etcd        0
3bbed54314720       2 minutes ago       Ready               coredns-summit-dtx69-master-0          openshift-kni-infra   0
----

Wait till the `network-operator` POD appears on the `crictl ps` output.

. Review the `tun0` device
+
[%nowrap]
----
[root@summit-dtx69-master-0 ~]# ip a s dev tun0
----
+
.Sample Output
[%nowrap]
----
6: tun0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1400 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether ee:02:36:2c:56:9d brd ff:ff:ff:ff:ff:ff
    inet 10.128.0.1/23 brd 10.128.1.255 scope global tun0
       valid_lft forever preferred_lft forever
    inet6 fe80::ec02:36ff:fe2c:569d/64 scope link
       valid_lft forever preferred_lft forever
----
+
[NOTE]
IP Corresponds to the OCP Cluster network

. Review Multus configuration
+
[%nowrap]
----
[root@master-0 ~]# cat /etc/kubernetes/cni/net.d/00-multus.conf  | jq "."
----
+
.Sample Output
[%nowrap]
----
{
  "cniVersion": "0.3.1",
  "name": "multus-cni-network",
  "type": "multus",
  "namespaceIsolation": true,
  "logLevel": "verbose",
  "binDir": "/opt/multus/bin",
  "kubeconfig": "/etc/kubernetes/cni/net.d/multus.d/multus.kubeconfig",
  "delegates": [
    {
      "cniVersion": "0.3.1",
      "name": "openshift-sdn",
      "type": "openshift-sdn"
    }
  ]
}
----

. Check the `cloud.conf` file
+
[%nowrap]
----
[root@master-0 kubernetes]# cat /etc/kubernetes/cloud.conf
----
+
.Expected Output
[%nowrap]
----
[Global]
secret-name = openstack-credentials
secret-namespace = kube-system
----
+
[NOTE]
OpenStack credentials are stored as a secret.

You can run `journalctl -f` to see the installation/configuration progress on the master node.


On our `bootstrap` VM you can observe the progress of the required pods creation
[%nowrap]
----
Jun 28 10:01:50 bootstrap bootkube.sh[1380]:         Pod Status:openshift-kube-apiserver/kube-apiserver        DoesNotExist
Jun 28 10:01:50 bootstrap bootkube.sh[1380]:         Pod Status:openshift-kube-scheduler/openshift-kube-scheduler        DoesNotExist
Jun 28 10:01:50 bootstrap bootkube.sh[1380]:         Pod Status:openshift-kube-controller-manager/kube-controller-manager        Pending
Jun 28 10:01:50 bootstrap bootkube.sh[1380]:         Pod Status:openshift-cluster-version/cluster-version-operator        Ready
Jun 28 10:01:55 bootstrap bootkube.sh[1380]:         Pod Status:openshift-cluster-version/cluster-version-operator        Ready
----

After some minutes the process will finish.
[%nowrap]
----
Jun 28 10:04:32 bootstrap bootkube.sh[1380]: Skipped "secret-kube-apiserver-to-kubelet-signer.yaml" secrets.v1./kube-apiserver-to-kubelet-signer -n openshift-kube-apiserver-operator as it already exists
Jun 28 10:04:32 bootstrap bootkube.sh[1380]: Skipped "secret-loadbalancer-serving-signer.yaml" secrets.v1./loadbalancer-serving-signer -n openshift-kube-apiserver-operator as it already exists
Jun 28 10:04:32 bootstrap bootkube.sh[1380]: Skipped "secret-localhost-serving-signer.yaml" secrets.v1./localhost-serving-signer -n openshift-kube-apiserver-operator as it already exists
Jun 28 10:04:33 bootstrap bootkube.sh[1380]: Skipped "secret-service-network-serving-signer.yaml" secrets.v1./service-network-serving-signer -n openshift-kube-apiserver-operator as it already exists
Jun 28 10:04:33 bootstrap bootkube.sh[1380]: bootkube.service complete
----

[IMPORTANT]
When the bootstrap process this VM will be deleted and your connection will be frozen. Open a new connection when this happens. Floating IP will be assigned to the master node.


Output of the `openshift-install` command will show the following output:
[%nowrap]
----
DEBUG Bootstrap status: complete
INFO Destroying the bootstrap resources...
<<OMITTED>>
DEBUG
DEBUG Destroy complete! Resources: 3 destroyed.
INFO Waiting up to 30m0s for the cluster at https://api.summit.example.com:6443 to initialize...
DEBUG Still waiting for the cluster to initialize: Working towards 4.3.1: 85% complete
----
+
[IMPORTANT]
Ignore errors similar to "Could not update servicemonitor" warnings.


At this moment we can see the installation progress.

. Configure `KUBECONFIG` environment variable and check status
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ echo "export KUBECONFIG=/home/stack/openshift/summit/auth/kubeconfig" >> ~/.bashrc
(openshift) [stack@undercloud openshift]$ source ~/.bashrc
(openshift) [stack@undercloud openshift]$ oc whoami
(openshift) [stack@undercloud openshift]$ oc get clusterversion
----
+
.Sample Output
[%nowrap]
----
NAME      VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
version             False       True          17m     Working towards 4.3.1: 91% complete
----
+
[Important]
Ignore the message in STATUS if is "Unable to apply 4.3.1: some cluster operators have not yet rolled out"


. List the cluster operators and the status
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ oc get clusteroperator
----
+
.Sample Output
[%nowrap]
----
NAME                                       VERSION                         AVAILABLE   PROGRESSING   DEGRADED   SINCE
authentication                                                             Unknown     Unknown       True       5m58s
cloud-credential                           4.3.1   True        False         False      12m
cluster-autoscaler                         4.3.1   True        False         False      8m22s
console                                    4.3.1   True        True          False      4m21s
dns                                        4.3.1   True        False         False      9m39s
image-registry                                                             False       True          False      105s
ingress                                    unknown                         False       True          False      103s
kube-apiserver                             4.3.1   True        True          False      8m37s
kube-controller-manager                    4.3.1   True        True          False      7m28s
kube-scheduler                             4.3.1   True        True          False      6m38s
machine-api                                4.3.1   True        False         False      12m
machine-config                             4.3.1   True        False         False      9m11s
marketplace                                4.3.1   True        False         False      67s
monitoring                                                                 False       True          True       1s
network                                    4.3.1   True        False         False      13m
node-tuning                                4.3.1   True        False         False      4m57s
openshift-apiserver                        4.3.1   False       False         False      103s
openshift-controller-manager               4.3.1   True        False         False      9m1s
openshift-samples                                                          False       False         False      104s
operator-lifecycle-manager                 4.3.1   True        True          False      8m26s
operator-lifecycle-manager-catalog         4.3.1   True        True          False      8m26s
operator-lifecycle-manager-packageserver                                   False       True          False      8m26s
service-ca                                 4.3.1   True        False         False      12m
service-catalog-apiserver                  4.3.1   True        False         False      5m57s
service-catalog-controller-manager         4.3.1   True        False         False      5m57s
storage                                    4.3.1   True        False         False      107s
support                                    4.3.1   True        False         False      12m
----


After some minutes the installation will finish.

[%nowrap]
----
DEBUG Cluster is initialized
INFO Waiting up to 10m0s for the openshift-console route to be created...
DEBUG Route found in openshift-console namespace: console
DEBUG Route found in openshift-console namespace: downloads
DEBUG OpenShift console route is created
INFO Install complete!
INFO To access the cluster as the system:admin user when using 'oc', run 'export KUBECONFIG=/home/stack/src/github.com/openshift/installer/summit/auth/kubeconfig'
INFO Access the OpenShift web-console here: https://console-openshift-console.apps.summit.example.com
INFO Login to the console with user: kubeadmin, password: JhDR4-uWKhc-mRQtH-Vde37

real	43m8.507s
user	0m39.151s
sys	0m2.511s
----


A new VM was created during the OpenShift installation

. Review new VM
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ openstack server list --name worker
----
+
.Sample Output
[%nowrap]
----
+--------------------------------------+-------------------------+--------+---------------------------------+-------+-----------+
| ID                                   | Name                    | Status | Networks                        | Image | Flavor    |
+--------------------------------------+-------------------------+--------+---------------------------------+-------+-----------+
| 663cbaaa-e28f-4d74-9918-ca4a29e933c1 | summit-dtx69-worker-smnfb | ACTIVE | summit-dtx69-openshift=10.0.0.14 | rhcos | m1.xlarge |
+--------------------------------------+-------------------------+--------+---------------------------------+-------+-----------+
----

. Review the OC nodes
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ oc get nodes
----
+
.Sample Output
[%nowrap]
----
NAME                      STATUS   ROLES    AGE     VERSION
summit-dtx69-master-0       Ready    master   32m     v1.14.0+f62c70b01
summit-dtx69-worker-smnfb   Ready    worker   3m15s   v1.14.0+f62c70b01
----

== Assign floating IP for the applications

. Create a floating IP for the applications
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack floating ip create public --tag apps
----
+
.Sample Output
[%nowrap]
----
+---------------------+--------------------------------------+
| Field               | Value                                |
+---------------------+--------------------------------------+
| created_at          | 2019-08-27T15:35:13Z                 |
| description         |                                      |
| fixed_ip_address    | None                                 |
| floating_ip_address | 192.0.2.71                           |
| floating_network_id | 5c643728-f13d-4e4d-853d-865b76d45027 |
| id                  | 3603c571-556b-476c-bafb-f34faa2e1b8b |
| name                | 192.0.2.71                           |
| port_id             | None                                 |
| project_id          | 31cd4d29cf6c479d9a72784ff4e4ad3c     |
| qos_policy_id       | None                                 |
| revision_number     | 0                                    |
| router_id           | None                                 |
| status              | DOWN                                 |
| subnet_id           | None                                 |
| updated_at          | 2019-08-27T15:35:13Z                 |
| tags                | ['apps']                             |
+---------------------+--------------------------------------+
----

. Check the port for `ingress`
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack port list  |grep --color=never -e "--" -e Name -e ingress-port
----
+
.Sample Output
[%nowrap]
----
+--------------------------------------+--------------------------+-------------------+----------------------------------------------------------------------------+--------+
| ID                                   | Name                     | MAC Address       | Fixed IP Addresses                                                         | Status |
+--------------------------------------+--------------------------+-------------------+----------------------------------------------------------------------------+--------+
| 6e7cbda6-7462-4f38-810d-3f30359e4e46 | summit-dtx69-ingress-port  | fa:16:3e:a3:8d:09 | ip_address='10.0.0.7', subnet_id='c9ac1bae-e44c-41e3-84b6-33991fa39ebe'   | DOWN   |
+--------------------------------------+--------------------------+-------------------+----------------------------------------------------------------------------+--------+
----
. Assign floating IP to the port
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ PORTINGRESS=$(openstack port list  |grep --color=never ingress-port | awk '{print $2}')
(openshift) [stack@undercloud ~]$ FIPINGRESS=$(openstack floating ip list --tags apps -c "Floating IP Address" -f value)
(openshift) [stack@undercloud ~]$ openstack floating ip set --port $PORTINGRESS $FIPINGRESS
----

. Register IP to be used as wildcard for applications
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ curl "http://classroom.example.com:8080/update?secret=redhat&domain=*.apps&addr=$FIPINGRESS"
----
+
.Sample Output
[%nowrap]
----
{"Success":true,"Message":"Updated A record for *.apps to IP address 192.0.2.76","Domain":"*.apps","Domains":["*.apps"],"Address":"192.0.2.76","AddrType":"A"}
----

. Test DNS record
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ dig +short test.apps.summit.example.com
192.0.2.76
----



== Check cluster health

. Check cluster version
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ oc get clusterversion
----
+
.Sample Output
[%nowrap]
----
NAME      VERSION                         AVAILABLE   PROGRESSING   SINCE   STATUS
version   4.3.1   True        False         41s     Cluster version is 4.3.1
----
+
[TIP]
It may take up to 10 minutes to display the  Cluster version number

. Check the `Machines`
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ oc get machine -n openshift-machine-api
----
+
.Sample Output
[%nowrap]
----
NAME                      STATE    TYPE        REGION   ZONE   AGE
summit-dtx69-master-0       ACTIVE   m1.xlarge            nova   38m
summit-dtx69-worker-smnfb   ACTIVE   m1.xlarge            nova   36m
----

You can get the information of the machines using `oc get machine -n openshift-machine-api  -o yaml`


== Test basic functionality

Now is time to test the basic functionality: create an app.

. Create a new project named `summit`
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ oc new-project summit
----
+
.Sample Output
[%nowrap]
----
Now using project "summit" on server "https://api.summit.example.com:6443".

You can add applications to this project with the 'new-app' command. For example, try:

    oc new-app django-psql-example

to build a new example application in Python. Or use kubectl to deploy a simple Kubernetes application:

    kubectl create deployment hello-node --image=gcr.io/hello-minikube-zero-install/hello-node
----
. Create a new sample apps
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ oc new-app django-psql-example
----
+
.Sample Output
[%nowrap]
----
<<OMITTED>>
--> Creating resources ...
    secret "django-psql-example" created
    service "django-psql-example" created
    route.route.openshift.io "django-psql-example" created
    imagestream.image.openshift.io "django-psql-example" created
    buildconfig.build.openshift.io "django-psql-example" created
    deploymentconfig.apps.openshift.io "django-psql-example" created
    service "postgresql" created
    deploymentconfig.apps.openshift.io "postgresql" created
--> Success
    Access your application via route 'django-psql-example-summit.apps.summit.example.com'
    Build scheduled, use 'oc logs -f bc/django-psql-example' to track its progress.
    Run 'oc status' to view your app.
----

. Check the status
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ watch oc status
----
+
.Sample Output
[%nowrap]
----
In project summit on server https://api.summit.example.com:6443

http://django-psql-example-summit.apps.summit.example.com (svc/django-psql-example)
  dc/django-psql-example deploys istag/django-psql-example:latest <-
    bc/django-psql-example source builds https://github.com/sclorg/django-ex.git on openshift/python:3.6
      build #1 running for 42 seconds - 0905223: Merge pull request #137 from danmcp/patch-1 (Ben Parees <bparees@users.noreply.github.com>)
    deployment #1 waiting on image or update

svc/postgresql - 172.30.174.52:5432
  dc/postgresql deploys openshift/postgresql:10
    deployment #1 waiting on image or update

View details with 'oc describe <resource>/<name>' or list everything with 'oc get all'.
----
+
Wait till the process have finished.

. Access to the application
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ curl -s django-psql-example-summit.apps.summit.example.com | grep title
----
+
[%nowrap]
----
  <title>Welcome to OpenShift</title>
----


. Add a `PersistentVolume` to the application.
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ oc set volume dc/django-psql-example --add --name=cinderexample -t pvc --claim-size=1G 
----
+
.Sample Output
[%nowrap]
----
deploymentconfig.apps.openshift.io/django-psql-example volume updated
----

. List the `PersistentVolumeClaim` objects
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ oc get pvc
NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
pvc-rfjq5   Bound    pvc-8628accb-117c-4f93-8604-d6de8f1cac20   1Gi        RWO            standard       43s
----

. List the `PersistentVolume` objects
+
[%nowrap]
----
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM              STORAGECLASS   REASON   AGE
pvc-8628accb-117c-4f93-8604-d6de8f1cac20   1Gi        RWO            Delete           Bound    summit/pvc-rfjq5   standard                87s
----

. List the OpenStack volumes
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack volume list
+--------------------------------------+---------------------------------------------------------------+--------+------+----------------------------------------------------+
| ID                                   | Name                                                          | Status | Size | Attached to                                        |
+--------------------------------------+---------------------------------------------------------------+--------+------+----------------------------------------------------+
| 1262ac2f-7087-42db-9944-1b36c54b45df | summit-z2lph-dynamic-pvc-8628accb-117c-4f93-8604-d6de8f1cac20 | in-use |    1 | Attached to summit-z2lph-worker-dj85b on /dev/vdb  |
+--------------------------------------+---------------------------------------------------------------+--------+------+----------------------------------------------------+
----




== Scale Up the cluster

. Check the current status
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ oc get machinesets -n openshift-machine-api
----

+
.Sample Output
[%nowrap]
----
NAME                DESIRED   CURRENT   READY   AVAILABLE   AGE
summit-brdjp-worker   1         1         1       1           48m
----

. Scale up the machine set to have 2 workers.
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ MS=$(oc get machinesets -n openshift-machine-api -o Name)
(openshift) [stack@undercloud ~]$ oc scale $MS --replicas=2 -n openshift-machine-api
----
+
.Sample Output
[%nowrap]
----
machineset.machine.openshift.io/summit-brdjp-worker scaled
----

. Check a new machine is created after scale up
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ oc get machine -n openshift-machine-api
----
+
.Sample Output
[%nowrap]
----
NAME                        PHASE          TYPE        REGION   ZONE   AGE
summit-psz4q-master-0       Running        m1.xlarge            nova   80m
summit-psz4q-worker-dj85b   Running        m1.large             nova   71m
summit-psz4q-worker-hq2hf   Provisioning                               8s
----

. After a while (around 7-8 minutes) it will appear the state ACTIVE and the type
+
[%nowrap]
----
NAME                        PHASE     TYPE        REGION   ZONE   AGE
summit-psz4q-master-0       Running	  m1.xlarge            nova   87m
summit-psz4q-worker-dj85b   Running	  m1.large             nova   79m
summit-psz4q-worker-hq2hf   Running   m1.large             nova   7m29s
----

. Check the VMs on OpenStack
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack server list --name worker
----

+
.Sample Output
[%nowrap]
----
+--------------------------------------+-------------------------+--------+---------------------------------+-------+-----------+
| ID                                   | Name                    | Status | Networks                        | Image | Flavor    |
+--------------------------------------+-------------------------+--------+---------------------------------+-------+-----------+
| f5f1e52d-ccf4-4c62-8241-36d4f76f49ee | summit-psz4q-worker-d4j2z | ACTIVE | summit-psz4q-openshift=10.0.0.24 | rhcos | m1.xlarge |
| 545860ed-e390-446a-a619-b899925bdc5a | summit-psz4q-worker-f9wbw | ACTIVE | summit-psz4q-openshift=10.0.0.16 | rhcos | m1.xlarge |
+--------------------------------------+-------------------------+--------+---------------------------------+-------+-----------+
----




. (Optional) Connect to the new worker and check the progress using `journalctl -f`
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ ssh core@10.0.0.16
[core@summit-brdjp-worker-6csgn ~]$ sudo journalctl -f
----

After some minutes the new worker node will appear in `oc get nodes` output.

[%nowrap]
----
(openshift) [stack@undercloud ~]$ watch oc get nodes
----

.Sample Output
[%nowrap]
----
NAME                      STATUS   ROLES    AGE     VERSION
summit-brdjp-master-0       Ready    master   94m     v1.14.0+f62c70b01
summit-brdjp-worker-6csgn   Ready    worker   4m43s   v1.14.0+f62c70b01
summit-brdjp-worker-8pbzb   Ready    worker   85m     v1.14.0+f62c70b01
----


== Scale Down the cluster

. Check current status
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ oc get machinesets -n openshift-machine-api
----
+
.Sample Output
[%nowrap]
----
NAME                DESIRED   CURRENT   READY   AVAILABLE   AGE
summit-brdjp-worker   2         2         2       2           97m
----

. Scale down to have only 1 worker
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ oc scale  $MS --replicas=1 -n openshift-machine-api
----
+
.Sample Output
[%nowrap]
----
machineset.machine.openshift.io/summit-brdjp-worker scaled
----

. Get the list of machines (repeat the command till only appears 1 worker)
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ watch oc get machine -n openshift-machine-api
----
+
.Sample Output
[%nowrap]
----
NAME                        PHASE      TYPE        REGION   ZONE   AGE
summit-z2lph-master-0       Running    m1.xlarge            nova   89m
summit-z2lph-worker-dj85b   Deleting   m1.large             nova   80m
summit-z2lph-worker-hq2hf   Running    m1.large             nova   8m41s
----

. Notice the VM on OpenStack was removed
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ openstack server list --name worker
----
+
.Sample Output
[%nowrap]
----
+--------------------------------------+-------------------------+--------+---------------------------------+-------+--------+
| ID                                   | Name                    | Status | Networks                        | Image | Flavor |
+--------------------------------------+-------------------------+--------+---------------------------------+-------+--------+
| c4708a42-e8c7-424c-a278-635a42e5b635 | summit-brdjp-worker-8pbzb | ACTIVE | summit-brdjp-openshift=10.0.0.25 | rhcos |        |
+--------------------------------------+-------------------------+--------+---------------------------------+-------+--------+
----


== Destroy Cluster

In case of need, the `openshift-install` can remove all the components of OpenShift inside OpenStack. This command can be used if the installation failed or in case we just want to delete an installation.


. Destroy the cluster
+
[%nowrap]
----
(openshift) [stack@undercloud ~]$ cd ~/openshift
(openshift) [stack@undercloud openshift]$ time ./openshift-install --log-level=debug destroy cluster --dir summit
----
+
.Example Output
[%nowrap]
----
DEBUG goroutine deleteSecurityGroups complete
DEBUG Purging asset "Terraform Variables" from disk
DEBUG Purging asset "Kubeconfig Admin Client" from disk
DEBUG Purging asset "Kubeadmin Password" from disk
DEBUG Purging asset "Certificate (journal-gatewayd)" from disk
DEBUG Purging asset "Metadata" from disk
DEBUG Purging asset "Cluster" from disk

real	2m28.967s
user	0m0.877s
sys	0m0.192s
----

. Check the servers were deleted
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ openstack server list
----

. Check the working directory is empty
+
[%nowrap]
----
(openshift) [stack@undercloud openshift]$ ls -l summit/
total 0
----
+
[NOTE]
It is a good practice to backup  the `install-config.yaml` outside of the working directory immediately after creating it.
